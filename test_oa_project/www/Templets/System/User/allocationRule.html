<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" />
    <title>系统首页-{$siteinfo.sitename}</title>
    <link rel="stylesheet" href="__PUBLIC__/css/common.css">
    <link rel="stylesheet" href="__PUBLIC__/js/asDatepicker/css/asDatepicker.css">
    <link rel="stylesheet" href="__PUBLIC__/css/addaNewRule.css?v=20160923">
    <script>
        var jump_code = "{$jump_code}";
    </script>
</head>
<body>
<div class="wrapBox">
    <div class="newEmployeesCont">
        <div class="nsContTop clearfix">
            <div class="topTit l">
                <span class="masterList">中心客户管理</span>
                <span><em>&gt;</em>添加新规则</span>
            </div>
            <div class="topRight r">
                <a href="javascript:history.go(-1);" class="return">返回</a>
            </div>
        </div>
        <div class="nsMiddle">
            <div class="nsRow clearfix">
                <div class="nsLeft"><i>&#42</i>分配规则名称:</div>
                <div class="nsRight">
                    <input type="text" class="nsInp" name="allocationname" placeholder="请输入分配规则名称">
                </div>
            </div>
            <div class="nsRow clearfix">
                <div class="nsLeft"><i>&#42</i>开始天数:</div>
                <div class="nsRight">
                    <input type="tel" class="nsInp" name="startnum" value="0" autocomplete="off">
                </div>
            </div>
            <div class="nsRow clearfix">
                <div class="nsLeft"><i>&#42</i>间隔天数:</div>
                <div class="nsRight">
                    <input type="tel" class="nsInp" name="intervalnum" value="0" autocomplete="off">
                </div>
            </div>
            <div class="nsRow clearfix">
                <div class="nsLeft"><i>&#42</i>分配排序:</div>
                <div class="nsRight">
                    <input type="tel" class="nsInp" name="sort" value="1" placeholder="值越小，优先级越高">
                </div>
            </div>
            <div class="nsRow clearfix">
                <div class="nsLeft"><i>&#42</i>所属区域:</div>
                <div class="nsRight">
                    <div class="selectbox2 l">
                        <dl class="select">
                            <dt>
                            <div class="select_title l" >请选择所属区域</div>
                            <div class="arrow r" ></div>
                            </dt>
                            <dd class="fxDone" data-value="{$data['zoneAll']['zone_id']}">{$data['zoneAll']['name']}</dd>
                            <if condition = "$data['zoneAll']['centersign'] neq 10">
                                <foreach name = "data['zoneAll']['children']" item = "v2">
                                    <dd class="fxDone zonesele zone_btn{$v2['zone_id']}" data-value="{$v2['zone_id']}">&nbsp;&nbsp;&nbsp;├─ {$v2['name']}</dd>
                                    <if condition = "!empty($v2['children']) ">
                                        <foreach name = "v2['children']" item = "v3">
                                            <dd class="fxDone zonesele zone_btn{$v3['zone_id']}" data-value="{$v3['zone_id']}">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;├─ {$v3['name']}</dd>
                                            <if condition = "!empty($v3['children'])">
                                                <foreach name = "v3['children']" item = "v4">
                                                    <dd class="fxDone zonesele zone_btn{$v4['zone_id']}" data-value="{$v4['zone_id']}">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;├─ {$v4['name']}</dd>
                                                </foreach>
                                            </if>
                                        </foreach>
                                    </if>
                                </foreach>
                            </if>
                        </dl>
                        <input type="hidden" name="zone_id"  autocomplete="off">
                    </div>
                </div>
            </div>
            <div class="nsRow clearfix">
                <div class="nsLeft"><i>&#42</i>渠道:</div>
                <div class="nsRight">
                    <div class="selectbox2 l">
                        <dl class="select">
                            <dt>
                            <div class="select_title l">选择渠道数据</div>
                            <div class="arrow r"></div>
                            </dt>
                            <foreach name="data['channel']['data']" item="v" key="k">
                                <dd class="fxDone" data-value="{$v.channel_id}">{$v.channelname}</dd>
                            </foreach>
                        </dl>
                        <input type="hidden" name="channel_id" autocomplete="off">
                    </div>
                </div>
            </div>

            <div class="nsRow clearfix">
                <div class="nsLeft"><i>&#42</i>分配对应职位:</div>
                <div class="nsRight clearfix" id="role_name">
                    <input type="text" class="nsInp nsDepartment l" disabled="disabled" name="role_name" autocomplete="off">
                    <input type="button" class="nsSelectPost l" value="选择职位">
                    <input type="hidden" name="role_id" value="" autocomplete="off">
                </div>
            </div>
            <div class="nsRow clearfix">
                <div class="nsLeft">分配对应人员:</div>
                <div class="nsRight clearfix">
                    <input type="text" class="nsInp nsDepartment l" disabled="disabled" name="system_name">
                    <input type="button" class="nsSelectPostMan l" value="选择员工">
                    <input type="hidden" name="system_user_id" value="" autocomplete="off">
                </div>
            </div>
            <div class="nsRow clearfix">
                <div class="nsLeft"><i>&#42</i>是否平均分配:</div>
                <div class="nsRight clearfix">
                    <label for="radioMan" class="manLabel">
                        <input type="radio" name="isave" class="nsRadio man" id="radioMan" checked="checked" value="1" autocomplete="off">
                        <span>是</span>
                    </label>
                    <label for="radioWoman">
                        <input type="radio" name="isave" class="nsRadio woMan" id="radioWoman" value="2" autocomplete="off">
                        <span>否</span>
                    </label>
                </div>
            </div>
            <div class="nsRow clearfix nsNone">
                <div class="nsLeft"><i>&#42</i>平均分配客户数:</div>
                <div class="nsRight">
                    <input type="tel" class="nsInp" name="allocationnum" placeholder="">
                </div>
            </div>
            <div class="nsRow clearfix">
                <div class="nsLeft">指定日期:</div>
                <div class="nsRight clearfix">
					<input type="text" name="specify_days" class="specified-date" readonly="readonly">
                </div>
            </div>
            <div class="nsRow clearfix">
                <div class="nsLeft">开启节日限制:</div>
                <div class="nsRight clearfix">
                    <div class="holiday_box fl">
                        <div data-value="2">关闭</div>
                    </div>
                    <input type="hidden" name="holiday" value="" autocomplete="off">
                </div>
            </div>
            <div class="nsRow clearfix">
                <div class="nsLeft"><i>&#42</i>允许启动星期:</div>
                <div class="nsRight clearfix">
                    <div class="week_box fl">
                        <div data-value="1">星期一</div>
                        <div data-value="2">星期二</div>
                        <div data-value="3">星期三</div>
                        <div data-value="4">星期四</div>
                        <div data-value="5">星期五</div>
                        <div data-value="6">星期六</div>
                        <div data-value="7">星期日</div>
                    </div>
                    <input type="hidden" name="week_text" value="" autocomplete="off">
                </div>
            </div>
            <div class="nsRow clearfix">
                <div class="nsLeft"><i>&#42</i>禁止分配的跟进状态:</div>
                <div class="nsRight clearfix">
                    <div class="ban_box fl">
                        <div data-value="1">意向学习</div>
                        <div data-value="2">承诺到访</div>
                        <div data-value="3">明确拒绝</div>
                        <div data-value="4">已培训</div>
                        <div data-value="5">已入职</div>
                        <div data-value="6">关机</div>
                        <div data-value="7">空号</div>
                        <div data-value="8">无人接听</div>
                        <div data-value="9">考虑</div>
                        <div data-value="11">年龄不符</div>
                        <div data-value="12">学历不符</div>
                        <div data-value="13">薪酬过高</div>
                        <div data-value="14">非本地客户</div>
                        <div data-value="10">其他</div>
                    </div>
                    <input type="hidden" name="banstatus" value="" autocomplete="off">
                </div>
            </div>
            <div class="nsRow clearfix">
                <div class="nsLeft">&nbsp;</div>
                <div class="nsRight">
                    <input type="submit" class="nsSubmit" value="提交">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 选择部门 S -->
<div class="department">
    <div class="nsTop clearfix">
        <span>选择所属部门及职位</span>
        <div class="nsClose"></div>
    </div>
    <div class="nsCont">
        <div class="nsSelectTop clearfix">
            <div class="selectbox nsSelectBox l">
                <dl class="select">
                    <dt>
                    <div class="select_title l nsSelectSearch_d">全部</div>
                    <div class="arrow r"></div>
                    </dt>
                    <dd class="fxDone" data-value="">全部</dd>
                    <foreach name="data['departmentAll'][data]" item="v" key="k">
                        <dd class="fxDone" data-value="{$v.department_id}">{$v.departmentname}</dd>
                    </foreach>
                </dl>
            </div>
            <input type="text" class="nsSelectSearch l" name="nsSelectSearch" placeholder="请输入职位">
            <input type="submit" class="nsSearchSubmit nsSearchSubmitRole l" value="搜索">
        </div>
        <div class="nsDeparMiddle">
            <dl class="nsTit clearfix department_title">
                <dt class="wNsOne">选中</dt>
                <dt class="wNsTwo">所属部门</dt>
                <dt class="wNsThr">职位名称</dt>
            </dl>
            <foreach name="data['roleAll'][data]" item="v" key="k">
                <dl class="clearfix department_content">
                    <dd class="wNsOne"><input type="checkbox" name="nsChk" class="nsSelectChk" value="{$v.id}" {:(in_array($v['id'],$data['is_roles']))?'checked="checked"':''}></dd>
                    <dd class="wNsTwo">{$v.department_name}</dd>
                    <dd class="wNsThr">{$v.name}</dd>
                </dl>
            </foreach>
        </div>
        <input type="button" class="nsDetermine nsDetermineRole" value="确定">
    </div>
</div>
<div class="dn">
    <div class="nsRow clearfix nssNone">
        <div class="nsLeft"><i>&#42</i>自定义分配客户数:</div>
        <div class="nsRight">
            <input type="tel" class="nsInp" name="allocationnum" placeholder="">
        </div>
    </div>
</div>
<div id="search_body" style="display: none">
    <foreach name="data['roleAll'][data]" item="v" key="k">
        <dl class="clearfix department_content">
            <dd class="wNsOne"><input type="checkbox" name="nsChk" class="nsSelectChk" value="{$v.id}"></dd>
            <dd class="wNsTwo">{$v.department_name}</dd>
            <dd class="wNsThr">{$v.name}</dd>
        </dl>
    </foreach>
</div>
<!-- 选择部门 E -->

<!-- 选择人员 S -->
<div class="departmentMan">
    <div class="nsTop clearfix">
        <span>选择人员名单</span>
        <div class="nsClose"></div>
    </div>
    <div class="nsCont">
        <div class="nsSelectTop clearfix">
            <input type="text" class="nsSelectSearch l" placeholder="请输入人员姓名">
            <input type="submit" class="nsSearchSubmit nsSearchSubmitSystem l" value="搜索">
        </div>
        <div class="nsDeparMiddle system_body">
            <dl class="nsTit clearfix">
                <dt class="wNsOne">选中</dt>
                <dt class="wNsTwo">所属职位</dt>
                <dt class="wNsThr">姓名</dt>
            </dl>
        </div>
        <input type="button" class="nsDetermine nsDetermineSystem" value="确定">
    </div>
</div>
<!-- 选择人员E -->

<script src="__PUBLIC__/js/jquery-1.9.1.min.js"></script>
<script src="__PUBLIC__/js/layer/layer.js"></script>
<script src="__PUBLIC__/js/asDatepicker/dist/jquery-asDatepicker.js"></script>
<script src="__PUBLIC__/js/addaNewRule.js?v=20160923"></script>
<script src="__PUBLIC__/js/common.js"></script>
<script>
    var specify_days = "";
    $(function(){
        //选择部门职位
        $('.nsDetermineRole').click(function(){
            var role_id = '';
            var role_name = ''
            $('.nsMiddle').find('.nssNone').remove();
            for(var i=0;i<$(':input[name="nsChk"]:checked').length;i++){
                if(i==0){
                    role_id += $(':input[name="nsChk"]:checked').eq(i).val();
                    role_name += $(':input[name="nsChk"]:checked').eq(i).parent().siblings('.wNsTwo').text()+'/'+$(':input[name="nsChk"]:checked').eq(i).parent().siblings('.wNsThr').text();
                }else{
                    role_id += ','+$(':input[name="nsChk"]:checked').eq(i).val();
                    role_name += '，'+$(':input[name="nsChk"]:checked').eq(i).parent().siblings('.wNsTwo').text()+'/'+$(':input[name="nsChk"]:checked').eq(i).parent().siblings('.wNsThr').text();
                }
                $('.dn .nssNone').children('.nsLeft').html('<i>&#42</i>'+$(':input[name="nsChk"]:checked').eq(i).parent().siblings('.wNsThr').text()+':');
                $('.nsNone').before( $('.dn .nssNone').clone());
                
            }
            $(':input[name="role_id"]').val(role_id);
            $(':input[name="role_name"]').val(role_name);
            $(':input[name="system_name"]').val('');
            $(':input[name="system_user_id"]').val('');
        });
        $('.zonesele').click(function(){
            $(':input[name="system_name"]').val('');
            $(':input[name="system_user_id"]').val('');
        });
        $('.nsDetermineSystem').click(function(){
            var system_id = '';
            var system_name = ''
            for(var i=0;i<$(':input[name="nsChk2"]:checked').length;i++){
                if(i==0){
                    system_id += $(':input[name="nsChk2"]:checked').eq(i).val();//$(':input[name="nsChk2"]:checked').eq(i).parent().siblings('.wNsTwo').text()+'/'+
                    system_name += $(':input[name="nsChk2"]:checked').eq(i).parent().siblings('.wNsThr').text();
                }else{
                    system_id += ','+$(':input[name="nsChk2"]:checked').eq(i).val();
                    system_name += '，'+$(':input[name="nsChk2"]:checked').eq(i).parent().siblings('.wNsThr').text();
                }
            }
            $(':input[name="system_name"]').val(system_name);
            $(':input[name="system_user_id"]').val(system_id);
        });
        //搜索职位相关-检索
        $('.nsSearchSubmitRole').click(function(){
            $(':input[name="nsChk"]').attr('checked',false);
            var val = $(':input[name="nsSelectSearch"]').val();
            var d_val = $('.nsSelectSearch_d').text();
            $('.nsDeparMiddle .department_content').remove();
            if(val.length>0 || d_val!='全部'){
                $('#search_body .department_content').each(function(i){
                    var zmnumReg=new RegExp( val ,'gim');
                    var zmnumReg2=new RegExp( d_val ,'gim');
                    var name=$(this);
                    if(d_val!='全部'){
                        if( zmnumReg.test(name.children('.wNsThr').text()) && zmnumReg2.test(name.children('.wNsTwo').text()) ){
                            $('.department_title').after(name.clone());
                        }
                    }else{
                        if( zmnumReg.test(name.children('.wNsThr').text()) ){
                            $('.department_title').after(name.clone());
                        }
                    }
                });
            }else{
                $('.department_title').after( $('#search_body .department_content').clone() );
            }
        });
        $('.nsSubmit').click(function(){
            var allocationnum = '';
            var isReturn = true;
            if($(':input[name="isave"]:checked').val()==2){
                $('.nsMiddle').find('.nssNone').each(function(){
                    var thisObj = $(this).find(':input[name="allocationnum"]');
                    if (isReturn) {
                        if(thisObj.val()==0 || thisObj.val()==''){
                            layer.msg(thisObj.parent().siblings('.nsLeft').text()+'分配数量不能为0', {icon:2});
                            isReturn = false;
                            return false;
                        }else{
                            if(allocationnum == ''){
                                allocationnum = thisObj.val();
                            }else{
                                allocationnum += ','+thisObj.val();
                            };
                        };
                    };
                });
                if (!isReturn) return false;
            }else{
                allocationnum = $('.nsNone').find(':input[name="allocationnum"]').val();
            };

            if( $(':input[name="week_text"]').val().length==0 ){
                layer.msg('必须选择启用星期', {icon:2});
                return false;
            };
            var data = {
                allocationname:$(':input[name="allocationname"]').val(),
                sort:$(':input[name="sort"]').val(),
                startnum:$(':input[name="startnum"]').val(),
                intervalnum:$(':input[name="intervalnum"]').val(),
                isave:$(':input[name="isave"]:checked').val(),
                allocationnum:allocationnum ,
                channel_id:$(':input[name="channel_id"]').val(),
                allocation_roles:$(':input[name="role_id"]').val(),
                system_user_ids:$(':input[name="system_user_id"]').val(),
                zone_id:$(':input[name="zone_id"]').val(),
                specify_days:$(':input[name="specify_days"]').val(),
                holiday:$(':input[name="holiday"]').val(),
                week_text:$(':input[name="week_text"]').val(),
                banstatus:$(':input[name="banstatus"]').val()
            };
            common_ajax(data);
        });

        $('.nsSearchSubmitSystem').click(function(){
            var search_name = $(this).siblings('.nsSelectSearch').val();
            var role_id = $(':input[name="role_id"]').val();
            var zone_id = $(':input[name="zone_id"]').val();
            getSystem (role_id,zone_id,search_name);
        });
    });
    function getSystem (role_ids,zone_id,search_name){
        $.ajax({
            url:"{:U('System/User/allocationRule')}",
            dataType:'json',
            type:'post',
            data:{type:'getSystem',role_id:role_ids,zone_id:zone_id,keyname:search_name},
            success:function(reflag){
                $('.systemli').remove();
                if(reflag.code==0){
                    var html = '';
                    $.each(reflag.data,function (k,v) {
                        html+= '<dl class="clearfix systemli"><dd class="wNsOne"><input type="checkbox" name="nsChk2" class="nsSelectChk" value="'+v.system_user_id+'"></dd><dd class="wNsTwo">'+v.role_names+'</dd><dd class="wNsThr">'+v.realname+'</dd></dl>';
                    })
                    $('.system_body').append(html);

                    var ids = $(':input[name="system_user_id"]').val();
                    if(ids){
                        ids = ids.split(',');
                        for(var i=0;i<ids.length;i++){
                            $('.btn_'+ids[i]).attr('checked',true);
                        }
                    }
                }else{
                    layer.msg(reflag.msg, {icon:2})
                }
            }
        });
    }
</script>
</body>
</html>