<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8"/>
    <title>系统首页-{$siteinfo.sitename}</title>
    <link rel="stylesheet" href="__PUBLIC__/css/common.css">
    <link rel="stylesheet" href="__PUBLIC__/css/external.min.css">
    <link rel="stylesheet" href="__PUBLIC__/css/payment.css">
    <script>
        var jump_code = "{$jump_code}";
    </script>
</head>
<body>
<div class="wrapBox">
    <div class="imCont">
        <div class="imContTop clearfix">
            <div class="topTit l">缴费管理</div>
        </div>
        <div class="forCondition clearfix">
            <form action="{:U('System/Fee/pay')}" method="get">
                <select class="payWay" name="receivetype">
                    <option value="0" {:$request['receivetype']=='0'?'selected="true"':''}>请选择收款方式</option>
                    <!--<option value="1" {:$request['receivetype']=='1'?'selected="true"':''}>现金</option>
                    <option value="2" {:$request['receivetype']=='2'?'selected="true"':''}>刷卡</option>
                    <option value="3" {:$request['receivetype']=='3'?'selected="true"':''}>转账</option>
                    <option value="4" {:$request['receivetype']=='4'?'selected="true"':''}>微信</option>
                    <option value="5" {:$request['receivetype']=='5'?'selected="true"':''}>支付宝</option>-->
                    <foreach  name="receiveType" item="receiveType_item" key="k">
                         <option value="{$k}" {:$request['receivetype']==$k?'selected="true"':''}>{$receiveType_item['text']}</option>
                    </foreach>

                </select>
                <select class="payPaymentStatus" name="pay_status">
                	<option value="0" selected="selected">请选择缴费状态</option>
                	<option value="1"  {:$request['pay_status']=='1'?'selected="true"':''}>欠费中</option>
                	<option value="2"{:$request['pay_status']=='2'?'selected="true"':''}>缴费完成</option>
                	<option value="3" {:$request['pay_status']=='3'?'selected="true"':''}>已退费</option>

                </select>
                <select class="payUser" name="key_name">
                    <option value="qq" {:$request['key_name']=='qq'?'selected="true"':''}>QQ</option>
                    <option value="username" {:$request['key_name']=='username'?'selected="true"':''}>手机号码</option>
                    <option value="tel" {:$request['key_name']=='tel'?'selected="true"':''}>固定电话</option>
                    <option value="realname" {:$request['key_name']=='realname'?'selected="true"':''}>真实姓名</option>
                </select>

                <input type="text" class="viInp l" name="key_value" placeholder="请输入相关关键字">
                <input type="submit" class="viSearchBtn l" value="搜索">
            </form>
        </div>

        <div class="forMiddle">
            <table cellpadding="0" cellspacing="0" id="forTable">
                <tr class="forHeader">
                    <th class="optionsTh">真实姓名</th>
                    <th>手机号码</th>
                    <th>QQ</th>
                    <th>固定电话</th>
                    <th>所属人</th>
                    <th>学费总额</th>
                    <th>优惠金额</th>
                    <th>实际缴费</th>
                    <th>欠费总额</th>
                    <th>是否贷款</th>
                    <th>贷款机构</th>
                    <th>延期付款</th>
                    <th>分期付款</th>
                    <th>缴费状态</th>
                    <th class="operatingTh">操作</th>
                </tr>
                <foreach name="payUsers" item="payUsers_item" key="k">
                    <tr>
                        <td class="optionsThTd">{$payUsers_item.realname}</td>
                        <td>{$payUsers_item.username}</td>
                        <td>{$payUsers_item.qq}</td>
                        <td>{$payUsers_item.tel}</td>
                        <td>{$payUsers_item.apply_realname}</td>
                        <td>{$payUsers_item.coursecount}</td>
                        <td>{$payUsers_item.discount_cost}</td>
                        <td>{$payUsers_item.paycount}</td>
                        <td>{$payUsers_item.arrearage}</td>
                        <td>{$payUsers_item.is_loan}</td>
                        <td>{$payUsers_item.loan_org}</td>
                        <td>{$payUsers_item.delayTx}</td>
                        <td>{$payUsers_item.instalmentsTx}</td>
                        <td>{$payUsers_item.pay_status}</td>
                        <td>
                            <!--120是退费状态, 退费不显示此项-->
                            <if condition="($payUsers_item[userstatus] neq 120)">
                                <a href="javascript:;" class="forSelect"><i></i></a>
                                <div class="otherOperation">
                                    <div class="triangle"></div>
                                    <div class="otherIcon">
                                        <ul>
                                            <!-- 2-缴费完成, 没有缴费完成才显示-->
                                            <if condition="($payUsers_item[pay_status] neq '缴费完成')">
                                                <li>
                                                    <a href="javascript:;" class="payReceivablesBtn"
                                                       data-value="{$payUsers_item.fee_id}::{$payUsers_item.realname}">
                                                        <span class="payReceivables"></span>
                                                        <em>收款</em>
                                                    </a>
                                                </li>
                                            </if>
                                            <li>
                                                <a href="javascript:;" class="payRefundBtn"
                                                   data-value="{$payUsers_item.fee_id}::{$payUsers_item.realname}::{$payUsers_item.paycount}">
                                                    <span class="payRefund"></span>
                                                    <em>退款</em>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <a  href="{:U('System/User/detailUser', array('id' => $payUsers_item['user_id']))}"  class="detailLink" target="_blank">详情</a>
                             </if>
                          </td>

                    </tr>

                </foreach>
            </table>
        </div>

        <div class="clearfix">
            <div class="collegaPage">
                {$paging}
            </div>
        </div>
    </div>
</div>

<div class="dn">
    <!-- 收款 s -->
    <div class="receivablesBox popup" id="receivables">
        <div class="reRow clearfix">
            <span><i>&nbsp</i>真实姓名：</span>
            <em></em>
        </div>
        <div class="reRow clearfix">
            <span><i>&#42</i>收款方式：</span>
            <select class="raSelect" id="paySelect">
                <option value="0">收款方式</option>
                <foreach  name="receiveType" item="receiveType_item" key="k">
                    <option value="{$k}">{$receiveType_item['text']}</option>
                </foreach>
            </select>
        </div>
        <div class="reRow clearfix">
            <span><i>&#42</i>收款金额：</span>
            <input type="text" class="refundAmountInp" name="payAmount">
        </div>
        <div class="reBtnBox clearfix">
            <input type="button" class="reConfirm" value="提交">
        </div>
    </div>
    <!-- 收款 e -->

    <!-- 退款 s -->
    <div class="returnBox popup" id="returnApplication">
        <div class="raRow clearfix">
            <span><i>&nbsp</i>真实姓名：</span>
            <em></em>
        </div>
        <div class="raRow clearfix">
            <span><i>&nbsp</i>实际缴费：</span>
            <em></em>
        </div>
        <div class="raRow clearfix">
            <span><i>&#42</i>退款方式：</span>
            <select class="raSelect" id="refundSelect">
                <option value="0">退款方式</option>
                <foreach  name="receiveType" item="receiveType_item" key="k">
                    <option value="{$k}">{$receiveType_item['text']}</option>
                </foreach>
            </select>
        </div>
        <div class="raRow clearfix">
            <span><i>&#42</i>退款金额：</span>
            <input type="text" class="refundAmountInp" name="refundAmount">
        </div>
        <div class="returnBtnBox clearfix">
            <input type="button" class="returnConfirm" value="提交">
        </div>
    </div>
    <!-- 退款 e -->

</div>

<script src="__PUBLIC__/js/jquery-1.9.1.min.js"></script>
<script src="__PUBLIC__/js/jquery.lib.min.js"></script>
<script src="__PUBLIC__/js/placeholder.js"></script>
<script src="__PUBLIC__/js/payment.js"></script>
<script src="__PUBLIC__/js/layer/layer.js"></script>
<script src="__PUBLIC__/js/common.js"></script>


<script>
    //确认收费
    $('.reConfirm').on('click', function () {
        var payAmount = $.trim($('input[name="payAmount"]').val());
        var patrn=/^[1-9]{1}([0-9]){1,5}$/;  //只能输入以1-9开头的正整数,最多是5位数
        if (!patrn.exec(payAmount)) {
            layer.msg('收款金额格式不正确,请输入5位以内非0开头的整数',{icon:2});
            return;
        }
        var data = {
            fee_id: feeId,
            pay: payAmount,
            receivetype: $("#paySelect  option:selected").attr('value')
        };
        common_ajax(data, "{:U('System/Fee/paySure')}",'loca');

        $("#receivables").colorbox.close();
    });
    //退款
    $('.returnConfirm').on('click', function () {
        var refundAmount = parseInt($.trim($(':input[name="refundAmount"]').val()));
        var patrn=/^[1-9]{1}([0-9]){1,5}$/;  //只能输入以1-9开头的正整数,最多是5位数
        if (!patrn.exec(refundAmount)) {
            layer.msg('退款金额格式不正确,请输入5位以内非0开头的整数',{icon:2});
            return;
        }
        var  payCount = parseInt($.trim($("#returnApplication .raRow").eq(1).children('em').text()));
        if(refundAmount > payCount ){
            layer.msg('退款金额不能大于预报金额,请重新输入',{icon:2});
            return;
        }
        var data = {
            fee_id: feeId,
            pay:refundAmount,
            receivetype: $("#refundSelect  option:selected").attr('value')
        };
        common_ajax(data, "{:U('System/Fee/payRefund')}", 'loca');

        $("#receivables").colorbox.close();
    });


</script>


</body>
</html>
