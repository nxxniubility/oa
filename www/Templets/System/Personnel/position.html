<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" />
    <title>系统首页-{$siteinfo.sitename}</title>
    <link rel="stylesheet" href="__PUBLIC__/css/common.css">
    <link rel="stylesheet" href="__PUBLIC__/css/jquery.treetable.css">
    <link rel="stylesheet" href="__PUBLIC__/css/jquery.treetable.theme.default.css">
    <link rel="stylesheet" href="__PUBLIC__/css/rightsManagement.css">
    <script>
        var jump_code = "{$jump_code}";
    </script>
</head>
<body>
<div class="wrapBox" id="posWrap">
    <div class="rightsCont">
        <div class="rightsContTop clearfix">
            <div class="topTit l"><span class="masterList">职位权限管理</span></div>
            <div class="topRight r">
                <a href="{:U('System/Personnel/addPosition')}" class="addPermissions">添加职位权限</a>
            </div>
        </div>
        
        <table cellpadding="0" cellspacing="0" id="positionTable">
        	<tr>
        		<th class="firItem">
        			<span>排序</span>
                    <i class="oergList" onclick="location.href='{$data[\'url_sort\']}'"></i>
        		</th>
        		<th>
        			<span>ID</span>
                    <i class="oergList" onclick="location.href='{$data[\'url_id\']}'"></i>
        		</th>
        		<th>职位名称</th>
        		<th>所属部门</th>
        		<th>职位描述</th>
        		<th>状态</th>
        		<th class="lastItem">操作</th>
        	</tr>
        	<foreach  name="data['roleAll']['data']" item="v" key="k">
        		<tr>
        			<td class="firItem">
        				<input type="tel" class="sequenceInp" value="{$v.sort}" oldSort="{$v.sort}"  data-id="{$v.id}" placeholder="0" maxlength="4" autocomplete="off">
        			</td>
        			<td class="role_id">{$v.id}</td>
        			<td>{$v.name}</td>
        			<td>{$v.department_name}</td>
        			<td>{$v.remark}</td>
        			<td><?php echo $v['display']==1?'启用':'禁用'; ?></td>
        			<td class="lastItem">
        				<div class="operating-cont">
	        				<a href="javascript:;" class="rightsSelect"><i></i></a>
	                        <div class="otherOperation">
	                            <div class="triangle"></div>
	                            <div class="otherIcon">
	                                <ul>
	                                    <li>
	                                        <a href="javascript:;" class="selectPermissions" sid="{$v.id}">
	                                            <span class="set"></span>
	                                            <em>权限设置</em>
	                                        </a>
	                                    </li>
	                                    <li>
	                                        <a href="{:U('System/Personnel/editPosition',array('role_id'=>$v['id']))}">
	                                            <span class="modify"></span>
	                                            <em>修改</em>
	                                        </a>
	                                    </li>
	                                    <li>
	                                        <a href="javascript:del_position('{$v.id}');">
	                                            <span class="delete"></span>
	                                            <em>删除</em>
	                                        </a>
	                                    </li>
	                                </ul>
	                            </div>
	                        </div>
	                   </div>
        			</td>
        		</tr>
        	</foreach>
        </table>

        <div class="collegaPage">
            <a class="sort"  id="sort" href="javascript:void(0)">排序</a>
            <span class="spTips l">'排序'列表内输入框的数字是可修改，再点击左侧按钮进行再排序的.</span>
            {$data['paging']}
        </div>
    </div>
</div>
<input type="hidden" value="" name="role_id">
<div class="competenceBox">
    <div class="addPerTop clearfix">
        <span>选择权限</span>
        <div class="addPerClose"></div>
    </div>
    <div class="boxMiddle">
        <div class="boxRows">
            <table id="boxTabel" width="100%" border="0" cellpadding="4" cellspacing="1" class="table treeTable">
                <tbody>
                {$data['nodeHtml']}
                </tbody>
            </table>
        </div>
    </div>
    <input type="button" class="addSubmit" value="提交">

</div>
<script src="__PUBLIC__/js/jquery-1.7.2.js"></script>
<script src="__PUBLIC__/js/layer/layer.js"></script>
<script src="__PUBLIC__/js/jquery.treetable.js"></script>
<script src="__PUBLIC__/js/common.js"></script>
<script src="__PUBLIC__/js/rightsManagement.js"></script>
<script>
    $(function(){
        //树配置
        $("#boxTabel").treeTable({
            expandable: true,
        });
		//修改排序值
		$('#sort').click(function(){
			var  ids_sort="";
			$(".sequenceInp").each(function(index, element) {
				if( $(this).val()!=$(this).attr('oldSort') ){							
					ids_sort+=','+$(this).attr('data-id')+'-'+$(this).val();
				}
			});
			if(ids_sort!="")ids_sort=ids_sort.substr(1);					
			var data = {
				sort_data:ids_sort,
				type:'sort'
			};
			common_ajax(data,"{:U('System/Personnel/dispostPosition')}",'reload');
			
		});
	
		//修改排序值
		$('.SequenceInp').blur(function(){
			
			var v=parseInt($.trim($(this).val()));
			
			if(!v)
			{
				$(this).val($(this).attr('oldSort'));
			}else{
				$(this).val(v);
			}
		})
       
        //修改权限-前置
        $('.addSubmit').click(function(){
            var role_id = $(':input[name="role_id"]').val();
            if(role_id!=''){
                //获取node_id
                var access='';
                if($('.radio:checked').length>0){
                    $('.radio:checked').each(function(i){
                        if(i==0){
                            access+=$(this).val()+'-'+$(this).attr('pid')+'-'+$(this).attr('level');
                        }else{
                            access+=','+$(this).val()+'-'+$(this).attr('pid')+'-'+$(this).attr('level');
                        }
                    });
                }
                edit_access(role_id,access);
            }
        })
    })
    //职位删除
    function del_position(role_id){
        layer.confirm('确定要删除该职位？', {
            btn: ['确定','取消'] //按钮
        }, function(){
            var data = {
                role_id:role_id,
                type:'del'
            };
            common_ajax(data,"{:U('System/Personnel/dispostPosition')}",'reload');
        }, function(){});
    }
    //职位权限修改
    function edit_access(role_id,access){
        layer.load(2);
        var data = {
            role_id:role_id,
            type:'access',
            access:access
        };
        $.ajax({
            url:"{:U('System/Personnel/dispostPosition')}",
            dataType:'json',
            type:'post',
            data:data,
            success:function(reflag){
                layer.closeAll('loading');
                if(reflag.code && reflag.code!=0){
                    layer.closeAll();
                    layer.msg(reflag.msg,{icon:2});
                }else{
                    layer.closeAll();
                    layer.msg(reflag.msg,{icon:1});
                }
                $(':input[name="role_id"]').val('');
            },
            error:function(){
                layer.closeAll();
                layer.msg('网络异常,请稍后再试！',{icon:2});
            }
        });
    }
</script>
</body>
</html>
